# CoreTool

<img src="images/Screenshot 2025-09-24 at 12.21.15.png"/>

## What is the CoreTool?

It consists of a number of indivitual napari plugins:

- **napari-interactive** is a base-plugin which
- **napari-interactive-sam2** uses the base-plugin to implement

- **napari-edit-log** is plugin that logs every user interaction and stores it in a log-file. This log-file can then be used to analyize to usage of the tool.

- **napari-shifted-preview** allows you to display masks across frames/layers, to ensure a more consistent segmentation experience.


## Installation

#### Prerequisites

The tool supports any device on which napari can run. However, the models powering the interactive segmentation might require specific hardware (GPUs with sufficient memory) or operation systems.

The tool is tested by the developers on MacOS and Linux. (If you are a windows user, please let us know of any issues you encounter.)

### Local Installation

For the local installation, you clone the repository and run `pip install -e` for all included plugin folders. If you now start napari, the plugins will appear in the plugins menu.

```bash
# Clone the repository

git clone

# Install the plugins
for plugin in /app/napari-*; do
    if [ -d "$plugin" ]; then
        echo "Installing plugin: $plugin"
        pip install -qq -e "$plugin"
    else
        echo "Skipping non-directory: $plugin"
    fi
done
``` 

### Installing only some plugins

In case you only need to use some specific plugin, already have napari installed, do not need/what them demo-widget, and do not need a development setup, you can install the plugins individually using pip.

```bash
# napari-interactive
pip install git+https://git.repo/some_repo.git#egg=$NAME_OF_PACKAGE&subdirectory=$SUBDIR_IN_REPO
```

### Alternatively using Docker-based

Alternatively, ou can use Docker to use the tool without installing it locally. Note that you might need to update the mounted paths, such that you can access your imaging files. The container image is quite large and cannot easily be used for local development.

>

## Getting Started / Overview

Use one of these three options to start napari and activate the core tool plugins you want to use. For the start we recommend loading the demo widget, to get to know the napari and plugin widget UI. To load the demo widget run the following command in your CLI.

```python
python3 startup.py
```

We recommend opening the 2D SAM2 demo while reading allong the Usage guide below.

## Usage

This section explains the overall princple.

### 2D+t/3D propagation


### 3D segmentation from 2D planes

## Reference

The following section contains detailed information on how to use the tool. Feel free to use it as a reference when using the core tool, or to.

### Importing/Opening images

Napari can open most types of images.

### Prediction

The predict control panel contains a single button to start the prediction of a segmentation mask, based on the currently provided prompt.


<img src="images/Screenshot 2025-09-24 at 12.22.23.png"/>

> By default, the autorun option is enabled and a new prediction is generated anytime the prompt or  the hyperparameters change. This is great for near instantanious feedback, but can be irretating if the prediction takes more than a few moments. For this case the autorun option can be disabled using the checkbox.

### Exporting masks

Masks generated by the tool can be exported in two ways. 

The `Export to layer` button copies the current state of the preview layer onto a seperate layer. This layer can then be used for other purposes or exported using the default `Save` option from napari.

The `Export to file` option allows for the direct export to the file system, under the provided path.

In any case the shape/dimensionality of the image is preserved and the dtype set to uint8.

<img src="images/Screenshot 2025-09-24 at 12.22.34.png"/>

### Reset

The `Reset` button clear the preview layer, the prompt layers and resets the underlying segmentation model.

<img src="images/Screenshot 2025-09-24 at 12.22.41.png"/>

### Windowing

To apply windowing to the image in the napari viewer (or to adjust the contrast), we recommend using the [napari-brightness-contrast](https://github.com/haesleinhuepf/napari-brightness-contrast) plugin. This plugin allows you to set custom window levels and widths for your images and includes a brightness histogram for better visualization.


<img src="images/Screenshot 2025-10-09 at 18.22.01.png"/>


A custom windowing plugin for the core-tool could be developed in the furture, but is currently not a priority.


### Multi Object Mode

The interactive 

<img src="images/Screenshot 2025-09-24 at 12.22.06.png"/>

### Propagaton

The propagation control plane exists for the 2D+t plugin. It allows for the propagation of the masks present in the current frame to be propagated to the next frame. 
The dimension in which the propagation occurs can be set with the spin-box. The direction of the propagation can be reversed with the reverse checkbox. The overwrite existing checkbox controlls if any existing delineations in the next frame should be overwritten by the propagation.

Multiple objects (with the same label index) can be propagated in parallel.

The step button is used to propagate from the current frame to the next frame, and make the new frame visible.
The run button starts a continous propagation (similar to repetedly clicking the step button), until it is pressed again.

<img src="images/Screenshot 2025-09-24 at 12.22.15.png"/>

> Tip: To continously segment the same target use the run option, as (at least for SAM2) only the run option uses the full 8-frame memory bank. Contounous clicking the Step button can also work, but only uses the last mask as prompt, thus providing less high quailty segmentation.

### The Edit Log

### Keyboard control

Napari (and the plugins of the core-tool) support a variety of keyboard shortcuts for controlling the viewer. They are mostly also tied to UI elements and can be discoverd by hovering with the pointer over any given UI element.

The most useful viewer shortcuts (for the purpose of interactive segmentation) include:

- **Switching between the tools**: "Number keys" (1-9)
- **Moving between frames**: "Arrow keys" (left / right)
- ...

The most usefull shortcuts from the core project plugins include:

- **Add new label**: `N`
- ...

> Tip: You can also customize these shortcuts to your liking in the [napari preferences menu](https://napari.org/dev/guides/preferences.html#shortcuts-settings).

### DemoWidget

The Demo Widget was developed to enable an easy showcase the core tool. It loads example imaging data and a correspoding interactive segmentation plugin.

<img src="images/demo_widget.png"/>

> Tip: Adding an new plugin/extended widget to the demo allows you to quickly reload the widget after changes to its code.

## Contributing

This plugins in this repository can be easily extended with support for new segmentation models.

PRs and other contributions from third parties are considered if they fit the overall goal of the core project.

### Development setup

1. Follow the local setup guide above.

2. Run the `development.ipynb` notebook to start napari and load the demo plugin. This way, hot-reloading is enabled. Alternatively, you can use the `startup.py` file to check the setup without hot-reloading

3. Make any desired changes to the source code.

### Adding support for new models

1. Follow the local setup guide above.

2. Select what mode/dimensionality your model/plugin should support. The core tool currently supports segmentation in one 2D plane, propagation from one 2D plane to an adjacent one (for 3D or 2D+t segmenation), and segmentation in 3D based on up to three prompts in orthogonal planes. Other modes can be implemented by extending the __view_control__ section of the base widget, see the [3D segmentataion](napari-interactive/src/napari_interactive/_widget_3d_sam.py) widget as an example.

3. Select a comperable widget and clone the respective file in `napari-interactive/src/napari_interactive/`.

4. Rename the copied file, for example `_widget_<mode>_<model>.py`.

5. Rename the widget class in that file.

6. Add the newly created widget class to the `__init__.py` and `napari.yaml` files.

7. (optionally) Create a demo to quickly load your new plugin, by extending the `demo_widget.py` file.

8. (optionally) use the `development.ipynb` notebook to start napari and enable hot-reloading of your plugin.

9. Start developing.

10. For loading model checkpoints we recomment hosting them on huggingface and downloading them on-demand via `huggingface_hub`. Alternatively, you can store them somewhere local.

### Using napari-interactive as a library

Alternatively, you can import the napari-interactive plugin class and create a new pip package for your model. See [here](https://napari.org/dev/plugins/building_a_plugin/first_plugin.html#your-first-plugin) on how to create a new napari-plugin.

1. Create a new plugin.

2. Add `napari-interactive` as a dependencie to your `requirements.txt`.

3. Import whatever widget class you want to use as parent and implement the plugin for your own model.

## License

Note that while this repository is available under Apache-2.0 license (see [LICENSE](./LICENSE)), the [model checkpoint](https://huggingface.co/nnInteractive/nnInteractive) is `Creative Commons Attribution Non Commercial Share Alike 4.0`!

______________________________________________________________________


## Acknowledgments

<p align="left">
  <img src="https://github.com/MIC-DKFZ/napari-nninteractive/raw/main/imgs/Logos/HI_Logo.png" width="150"> &nbsp;&nbsp;&nbsp;&nbsp;
  <img src="https://github.com/MIC-DKFZ/napari-nninteractive/raw/main/imgs/Logos/DKFZ_Logo.png" width="500">
</p>

This repository is developed and maintained by the Applied Computer Vision Lab (ACVL)
of [Helmholtz Imaging](https://www.helmholtz-imaging.de/) and the
[Division of Medical Image Computing](https://www.dkfz.de/en/medical-image-computing) at DKFZ.

[napari]: https://github.com/napari/napari